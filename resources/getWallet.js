"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.handler = void 0;
const cs = require("@cubist-labs/cubesigner-sdk");
const CubeSignerClient_1 = require("./CubeSignerClient");
const dbFunctions_1 = require("./dbFunctions");
const web3_js_1 = require("@solana/web3.js");
const ORG_ID = process.env["ORG_ID"];
const env = {
    SignerApiRoot: process.env["CS_API_ROOT"] ?? "http://gamma.signer.cubist.dev",
};
const aws_sdk_1 = require("aws-sdk");
const secretName = "CubeSignerToken0E1D2960-qP9dUIeYntSs";
const region = "us-east-1";
const client = new aws_sdk_1.SecretsManager({ region: region });
const handler = async (event) => {
    try {
        // console.log(
        //   "Event",ORG_ID,
        //   event.identity,
        //   event.arguments,
        //   event.request.headers.identity
        // );
        const secret = await getSecretValue(secretName);
        console.log("Secret", secret);
        const balance = await getSolBalance("HGRj74N58LwbjSLxQ66UDoZQpLF3mnSve4uJ3xtF6Pg9");
        console.log("Balance", balance);
        const wallet = await createUser(event.identity, event.arguments?.tenantUserId, event.request?.headers?.identity);
        return {
            statusCode: 200,
            body: {
                data: event.arguments,
                error: null,
                wallet: wallet,
                balance: balance,
            },
        };
    }
    catch (err) {
        console.log("In catch Block Error", err);
        return {
            statusCode: 400,
            body: {
                data: event.arguments,
                error: err
            },
        };
    }
};
exports.handler = handler;
async function getSecretValue(secretName) {
    try {
        console.log("Getting secret value", secretName);
        const data = await client
            .getSecretValue({ SecretId: secretName })
            .promise();
        console.log("Secret value", data);
        if ("SecretString" in data) {
            return data.SecretString;
        }
        else {
            let buff = Buffer.from(data.SecretBinary, "base64");
            return buff.toString("ascii");
        }
    }
    catch (err) {
        console.log(err);
        return err;
    }
}
async function createUser(tenant, tenantuserid, oidcToken) {
    console.log("Creating user");
    try {
        // const customer = await getCustomer(tenantuserid, tenant.id);
        // if (customer != null && customer.cubistuserid) {
        //   const wallet = await getWalletByCustomer(tenantuserid, "SOL", tenant);
        //   return {
        //     wallet,
        //     tenantUserId: tenantuserid,
        //   };
        // } else {
        const { client, org } = await (0, CubeSignerClient_1.getCsClient)();
        console.log("Creating user", client);
        const proof = await cs.CubeSignerClient.proveOidcIdentity(env, ORG_ID, oidcToken);
        console.log("Verifying identity", proof);
        await org.verifyIdentity(proof);
        console.log("Verified");
        //assert(proof.identity, "Identity should be set when proof is obtained using OIDC token");
        const iss = proof.identity.iss;
        const sub = proof.identity.sub;
        const email = proof.email;
        const name = proof.preferred_username;
        // If user does not exist, create it
        if (!proof.user_info?.user_id) {
            console.log(`Creating OIDC user ${email}`);
            const org = client.org();
            const cubistUserId = await org.createOidcUser({ iss, sub }, email, {
                name,
            });
            console.log(`Creating key for user ${cubistUserId}...`);
            const customer = await (0, dbFunctions_1.createCustomer)({
                emailid: email ? email : "",
                name: name ? name : "",
                tenantuserid,
                tenantid: tenant.id,
                cubistuserid: cubistUserId,
                isactive: true,
                createdat: new Date().toISOString(),
            });
            const wallet = await (0, dbFunctions_1.createWallet)(org, cubistUserId, customer);
            return {
                wallet,
                tenantUserId: tenantuserid,
            };
        }
        else {
            const wallet = await (0, dbFunctions_1.getWalletByCustomer)(tenantuserid, "SOL", tenant);
            return {
                wallet,
                tenantUserId: tenantuserid,
            };
        }
        // }
    }
    catch (e) {
        console.log(`Not verified: ${e}`);
        throw e;
    }
}
async function getSolBalance(address) {
    try {
        console.log("Address", address);
        const pubkey = new web3_js_1.PublicKey(address);
        console.log("pubkey", pubkey);
        const connection = await getSolConnection();
        console.log(connection, "connection");
        console.log(await connection.getBalance(pubkey), "connection");
        const balance = (await connection.getBalance(pubkey)) / web3_js_1.LAMPORTS_PER_SOL;
        console.log("Balance", balance);
        return balance;
    }
    catch (err) {
        console.log(err);
        //throw err;
        return 0;
    }
}
async function getSolConnection() {
    // const connection = new Connection(SOLANA_RPC_PROVIDER, "confirmed");
    const connection = new web3_js_1.Connection((0, web3_js_1.clusterApiUrl)("devnet"), "confirmed");
    return connection;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZ2V0V2FsbGV0LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiZ2V0V2FsbGV0LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7OztBQUFBLGtEQUFrRDtBQUVsRCx5REFBaUQ7QUFDakQsK0NBS3VCO0FBQ3ZCLDZDQUt5QjtBQUN6QixNQUFNLE1BQU0sR0FBRyxPQUFPLENBQUMsR0FBRyxDQUFDLFFBQVEsQ0FBRSxDQUFDO0FBQ3RDLE1BQU0sR0FBRyxHQUFRO0lBQ2YsYUFBYSxFQUFFLE9BQU8sQ0FBQyxHQUFHLENBQUMsYUFBYSxDQUFDLElBQUksZ0NBQWdDO0NBQzlFLENBQUM7QUFDRixxQ0FBeUM7QUFFekMsTUFBTSxVQUFVLEdBQUcsc0NBQXNDLENBQUM7QUFDMUQsTUFBTSxNQUFNLEdBQUcsV0FBVyxDQUFDO0FBRTNCLE1BQU0sTUFBTSxHQUFHLElBQUksd0JBQWMsQ0FBQyxFQUFFLE1BQU0sRUFBRSxNQUFNLEVBQUUsQ0FBQyxDQUFDO0FBRS9DLE1BQU0sT0FBTyxHQUFHLEtBQUssRUFBRSxLQUFVLEVBQUUsRUFBRTtJQUMxQyxJQUFJLENBQUM7UUFDSCxlQUFlO1FBQ2Ysb0JBQW9CO1FBQ3BCLG9CQUFvQjtRQUNwQixxQkFBcUI7UUFDckIsbUNBQW1DO1FBQ25DLEtBQUs7UUFFTCxNQUFNLE1BQU0sR0FBRyxNQUFNLGNBQWMsQ0FBQyxVQUFVLENBQUMsQ0FBQztRQUNoRCxPQUFPLENBQUMsR0FBRyxDQUFDLFFBQVEsRUFBRSxNQUFNLENBQUMsQ0FBQztRQUM5QixNQUFNLE9BQU8sR0FBRyxNQUFNLGFBQWEsQ0FBQyw4Q0FBOEMsQ0FBQyxDQUFDO1FBQ3hGLE9BQU8sQ0FBQyxHQUFHLENBQUMsU0FBUyxFQUFFLE9BQU8sQ0FBQyxDQUFDO1FBQzVCLE1BQU0sTUFBTSxHQUFHLE1BQU0sVUFBVSxDQUM3QixLQUFLLENBQUMsUUFBa0IsRUFDeEIsS0FBSyxDQUFDLFNBQVMsRUFBRSxZQUFZLEVBQzdCLEtBQUssQ0FBQyxPQUFPLEVBQUUsT0FB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QVcsQ0FBQyxDQUFDO0lBQ3ZFLE9BQU8sVUFBVSxDQUFDO0FBQ3BCLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgKiBhcyBjcyBmcm9tIFwiQGN1YmlzdC1sYWJzL2N1YmVzaWduZXItc2RrXCI7XHJcbmltcG9ydCB7IHRlbmFudCB9IGZyb20gXCIuL21vZGVsc1wiO1xyXG5pbXBvcnQgeyBnZXRDc0NsaWVudCB9IGZyb20gXCIuL0N1YmVTaWduZXJDbGllbnRcIjtcclxuaW1wb3J0IHtcclxuICBjcmVhdGVDdXN0b21lcixcclxuICBjcmVhdGVXYWxsZXQsXHJcbiAgZ2V0Q3VzdG9tZXIsXHJcbiAgZ2V0V2FsbGV0QnlDdXN0b21lcixcclxufSBmcm9tIFwiLi9kYkZ1bmN0aW9uc1wiO1xyXG5pbXBvcnQge1xyXG4gIENvbm5lY3Rpb24sXHJcbiAgTEFNUE9SVFNfUEVSX1NPTCxcclxuICBQdWJsaWNLZXksXHJcbiAgR2V0UHJvZ3JhbUFjY291bnRzRmlsdGVyLGNsdXN0ZXJBcGlVcmwsXHJcbn0gZnJvbSBcIkBzb2xhbmEvd2ViMy5qc1wiO1xyXG5jb25zdCBPUkdfSUQgPSBwcm9jZXNzLmVudltcIk9SR19JRFwiXSE7XHJcbmNvbnN0IGVudjogYW55ID0ge1xyXG4gIFNpZ25lckFwaVJvb3Q6IHByb2Nlc3MuZW52W1wiQ1NfQVBJX1JPT1RcIl0gPz8gXCJodHRwOi8vZ2FtbWEuc2lnbmVyLmN1YmlzdC5kZXZcIixcclxufTtcclxuaW1wb3J0IHsgU2VjcmV0c01hbmFnZXIgfSBmcm9tIFwiYXdzLXNka1wiO1xyXG5cclxuY29uc3Qgc2VjcmV0TmFtZSA9IFwiQ3ViZVNpZ25lclRva2VuMEUxRDI5NjAtcVA5ZFVJZVludFNzXCI7XHJcbmNvbnN0IHJlZ2lvbiA9IFwidXMtZWFzdC0xXCI7XHJcblxyXG5jb25zdCBjbGllbnQgPSBuZXcgU2VjcmV0c01hbmFnZXIoeyByZWdpb246IHJlZ2lvbiB9KTtcclxuXHJcbmV4cG9ydCBjb25zdCBoYW5kbGVyID0gYXN5bmMgKGV2ZW50OiBhbnkpID0+IHtcclxuICB0cnkge1xyXG4gICAgLy8gY29uc29sZS5sb2coXHJcbiAgICAvLyAgIFwiRXZlbnRcIixPUkdfSUQsXHJcbiAgICAvLyAgIGV2ZW50LmlkZW50aXR5LFxyXG4gICAgLy8gICBldmVudC5hcmd1bWVudHMsXHJcbiAgICAvLyAgIGV2ZW50LnJlcXVlc3QuaGVhZGVycy5pZGVudGl0eVxyXG4gICAgLy8gKTtcclxuXHJcbiAgICBjb25zdCBzZWNyZXQgPSBhd2FpdCBnZXRTZWNyZXRWYWx1ZShzZWNyZXROYW1lKTtcclxuICAgIGNvbnNvbGUubG9nKFwiU2VjcmV0XCIsIHNlY3JldCk7XHJcbiAgICBjb25zdCBiYWxhbmNlID0gYXdhaXQgZ2V0U29sQmFsYW5jZShcIkhHUmo3NE41OEx3YmpTTHhRNjZVRG9aUXBMRjNtblN2ZTR1SjN4dEY2UGc5XCIpO1xyXG5jb25zb2xlLmxvZyhcIkJhbGFuY2VcIiwgYmFsYW5jZSk7XHJcbiAgICBjb25zdCB3YWxsZXQgPSBhd2FpdCBjcmVhdGVVc2VyKFxyXG4gICAgICBldmVudC5pZGVudGl0eSBhcyB0ZW5hbnQsXHJcbiAgICAgIGV2ZW50LmFyZ3VtZW50cz8udGVuYW50VXNlcklkLFxyXG4gICAgICBldmVudC5yZXF1ZXN0Py5oZWFkZXJzPy5pZGVudGl0eVxyXG4gICAgKTtcclxuXHJcbiAgICByZXR1cm4ge1xyXG4gICAgICBzdGF0dXNDb2RlOiAyMDAsXHJcbiAgICAgIGJvZHk6IHtcclxuICAgICAgICBkYXRhOiBldmVudC5hcmd1bWVudHMsXHJcbiAgICAgICAgZXJyb3I6IG51bGwsXHJcbiAgICAgICAgd2FsbGV0OiB3YWxsZXQsXHJcbiAgICAgICAgYmFsYW5jZTogYmFsYW5jZSxcclxuICAgICAgfSxcclxuICAgIH07XHJcbiAgfSBjYXRjaCAoZXJyKSB7XHJcbiAgICBjb25zb2xlLmxvZyhcIkluIGNhdGNoIEJsb2NrIEVycm9yXCIsIGVycik7XHJcbiAgICByZXR1cm4ge1xyXG4gICAgICBzdGF0dXNDb2RlOiA0MDAsXHJcbiAgICAgIGJvZHk6IHtcclxuICAgICAgICBkYXRhOiBldmVudC5hcmd1bWVudHMsXHJcbiAgICAgICAgZXJyb3I6IGVyclxyXG4gICAgICAgICAgICB9LFxyXG4gICAgfTtcclxuICB9XHJcbn07XHJcblxyXG5hc3luYyBmdW5jdGlvbiBnZXRTZWNyZXRWYWx1ZShzZWNyZXROYW1lOiBzdHJpbmcpIHtcclxuICB0cnkge1xyXG4gICAgY29uc29sZS5sb2coXCJHZXR0aW5nIHNlY3JldCB2YWx1ZVwiLCBzZWNyZXROYW1lKTtcclxuICAgIGNvbnN0IGRhdGEgPSBhd2FpdCBjbGllbnRcclxuICAgICAgLmdldFNlY3JldFZhbHVlKHsgU2VjcmV0SWQ6IHNlY3JldE5hbWUgfSlcclxuICAgICAgLnByb21pc2UoKTtcclxuICAgIGNvbnNvbGUubG9nKFwiU2VjcmV0IHZhbHVlXCIsIGRhdGEpO1xyXG4gICAgaWYgKFwiU2VjcmV0U3RyaW5nXCIgaW4gZGF0YSkge1xyXG4gICAgICByZXR1cm4gZGF0YS5TZWNyZXRTdHJpbmcgYXMgc3RyaW5nO1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgbGV0IGJ1ZmYgPSBCdWZmZXIuZnJvbShkYXRhLlNlY3JldEJpbmFyeSBhcyBzdHJpbmcsIFwiYmFzZTY0XCIpO1xyXG4gICAgICByZXR1cm4gYnVmZi50b1N0cmluZyhcImFzY2lpXCIpO1xyXG4gICAgfVxyXG4gIH0gY2F0Y2ggKGVycikge1xyXG4gICAgY29uc29sZS5sb2coZXJyKTtcclxuICAgIHJldHVybiBlcnI7XHJcbiAgfVxyXG59XHJcblxyXG5hc3luYyBmdW5jdGlvbiBjcmVhdGVVc2VyKFxyXG4gIHRlbmFudDogdGVuYW50LFxyXG4gIHRlbmFudHVzZXJpZDogc3RyaW5nLFxyXG4gIG9pZGNUb2tlbjogc3RyaW5nXHJcbikge1xyXG4gIGNvbnNvbGUubG9nKFwiQ3JlYXRpbmcgdXNlclwiKTtcclxuXHJcbiAgdHJ5IHtcclxuICAgIC8vIGNvbnN0IGN1c3RvbWVyID0gYXdhaXQgZ2V0Q3VzdG9tZXIodGVuYW50dXNlcmlkLCB0ZW5hbnQuaWQpO1xyXG4gICAgLy8gaWYgKGN1c3RvbWVyICE9IG51bGwgJiYgY3VzdG9tZXIuY3ViaXN0dXNlcmlkKSB7XHJcbiAgICAvLyAgIGNvbnN0IHdhbGxldCA9IGF3YWl0IGdldFdhbGxldEJ5Q3VzdG9tZXIodGVuYW50dXNlcmlkLCBcIlNPTFwiLCB0ZW5hbnQpO1xyXG4gICAgLy8gICByZXR1cm4ge1xyXG4gICAgLy8gICAgIHdhbGxldCxcclxuICAgIC8vICAgICB0ZW5hbnRVc2VySWQ6IHRlbmFudHVzZXJpZCxcclxuICAgIC8vICAgfTtcclxuICAgIC8vIH0gZWxzZSB7XHJcbiAgICAgIGNvbnN0IHsgY2xpZW50LCBvcmcgfSA9IGF3YWl0IGdldENzQ2xpZW50KCk7XHJcbiAgICAgIGNvbnNvbGUubG9nKFwiQ3JlYXRpbmcgdXNlclwiLCBjbGllbnQpO1xyXG4gICAgICBjb25zdCBwcm9vZiA9IGF3YWl0IGNzLkN1YmVTaWduZXJDbGllbnQucHJvdmVPaWRjSWRlbnRpdHkoXHJcbiAgICAgICAgZW52LFxyXG4gICAgICAgIE9SR19JRCxcclxuICAgICAgICBvaWRjVG9rZW5cclxuICAgICAgKTtcclxuXHJcbiAgICAgIGNvbnNvbGUubG9nKFwiVmVyaWZ5aW5nIGlkZW50aXR5XCIsIHByb29mKTtcclxuXHJcbiAgICAgIGF3YWl0IG9yZy52ZXJpZnlJZGVudGl0eShwcm9vZik7XHJcbiAgICAgIGNvbnNvbGUubG9nKFwiVmVyaWZpZWRcIik7XHJcblxyXG4gICAgICAvL2Fzc2VydChwcm9vZi5pZGVudGl0eSwgXCJJZGVudGl0eSBzaG91bGQgYmUgc2V0IHdoZW4gcHJvb2YgaXMgb2J0YWluZWQgdXNpbmcgT0lEQyB0b2tlblwiKTtcclxuICAgICAgY29uc3QgaXNzID0gcHJvb2YuaWRlbnRpdHkhLmlzcztcclxuICAgICAgY29uc3Qgc3ViID0gcHJvb2YuaWRlbnRpdHkhLnN1YjtcclxuICAgICAgY29uc3QgZW1haWwgPSBwcm9vZi5lbWFpbDtcclxuICAgICAgY29uc3QgbmFtZSA9IHByb29mLnByZWZlcnJlZF91c2VybmFtZTtcclxuXHJcbiAgICAgIC8vIElmIHVzZXIgZG9lcyBub3QgZXhpc3QsIGNyZWF0ZSBpdFxyXG4gICAgICBpZiAoIXByb29mLnVzZXJfaW5mbz8udXNlcl9pZCkge1xyXG4gICAgICAgIGNvbnNvbGUubG9nKGBDcmVhdGluZyBPSURDIHVzZXIgJHtlbWFpbH1gKTtcclxuICAgICAgICBjb25zdCBvcmcgPSBjbGllbnQub3JnKCk7XHJcbiAgICAgICAgY29uc3QgY3ViaXN0VXNlcklkID0gYXdhaXQgb3JnLmNyZWF0ZU9pZGNVc2VyKHsgaXNzLCBzdWIgfSwgZW1haWwsIHtcclxuICAgICAgICAgIG5hbWUsXHJcbiAgICAgICAgfSk7XHJcbiAgICAgICAgY29uc29sZS5sb2coYENyZWF0aW5nIGtleSBmb3IgdXNlciAke2N1YmlzdFVzZXJJZH0uLi5gKTtcclxuXHJcbiAgICAgICAgY29uc3QgY3VzdG9tZXIgPSBhd2FpdCBjcmVhdGVDdXN0b21lcih7XHJcbiAgICAgICAgICBlbWFpbGlkOiBlbWFpbCA/IGVtYWlsIDogXCJcIixcclxuICAgICAgICAgIG5hbWU6IG5hbWUgPyBuYW1lIDogXCJcIixcclxuICAgICAgICAgIHRlbmFudHVzZXJpZCxcclxuICAgICAgICAgIHRlbmFudGlkOiB0ZW5hbnQuaWQsXHJcbiAgICAgICAgICBjdWJpc3R1c2VyaWQ6IGN1YmlzdFVzZXJJZCxcclxuICAgICAgICAgIGlzYWN0aXZlOiB0cnVlLFxyXG4gICAgICAgICAgY3JlYXRlZGF0OiBuZXcgRGF0ZSgpLnRvSVNPU3RyaW5nKCksXHJcbiAgICAgICAgfSk7XHJcblxyXG4gICAgICAgIGNvbnN0IHdhbGxldCA9IGF3YWl0IGNyZWF0ZVdhbGxldChvcmcsIGN1YmlzdFVzZXJJZCwgY3VzdG9tZXIpO1xyXG5cclxuICAgICAgICByZXR1cm4ge1xyXG4gICAgICAgICAgd2FsbGV0LFxyXG4gICAgICAgICAgdGVuYW50VXNlcklkOiB0ZW5hbnR1c2VyaWQsXHJcbiAgICAgICAgfTtcclxuICAgICAgfVxyXG4gICAgICBlbHNle1xyXG4gICAgICAgIGNvbnN0IHdhbGxldCA9IGF3YWl0IGdldFdhbGxldEJ5Q3VzdG9tZXIodGVuYW50dXNlcmlkLCBcIlNPTFwiLCB0ZW5hbnQpO1xyXG4gICAgICAgIHJldHVybiB7XHJcbiAgICAgICAgICB3YWxsZXQsXHJcbiAgICAgICAgICB0ZW5hbnRVc2VySWQ6IHRlbmFudHVzZXJpZCxcclxuICAgICAgICB9O1xyXG4gICAgICB9XHJcbiAgICAvLyB9XHJcbiAgfSBjYXRjaCAoZSkge1xyXG4gICAgY29uc29sZS5sb2coYE5vdCB2ZXJpZmllZDogJHtlfWApO1xyXG4gICAgdGhyb3cgZTtcclxuICB9XHJcbn1cclxuYXN5bmMgZnVuY3Rpb24gZ2V0U29sQmFsYW5jZShhZGRyZXNzOiBzdHJpbmcpIHtcclxuICB0cnkge1xyXG4gICAgY29uc29sZS5sb2coXCJBZGRyZXNzXCIsIGFkZHJlc3MpO1xyXG4gICAgY29uc3QgcHVia2V5ID0gbmV3IFB1YmxpY0tleShhZGRyZXNzKTtcclxuICAgIGNvbnNvbGUubG9nKFwicHVia2V5XCIsIHB1YmtleSk7XHJcblxyXG4gICAgY29uc3QgY29ubmVjdGlvbiA9IGF3YWl0IGdldFNvbENvbm5lY3Rpb24oKTtcclxuICAgIGNvbnNvbGUubG9nKGNvbm5lY3Rpb24sIFwiY29ubmVjdGlvblwiKTtcclxuICAgIGNvbnNvbGUubG9nKGF3YWl0IGNvbm5lY3Rpb24uZ2V0QmFsYW5jZShwdWJrZXkpLCBcImNvbm5lY3Rpb25cIik7XHJcblxyXG4gICAgY29uc3QgYmFsYW5jZSA9IChhd2FpdCBjb25uZWN0aW9uLmdldEJhbGFuY2UocHVia2V5KSkgLyBMQU1QT1JUU19QRVJfU09MO1xyXG4gICAgY29uc29sZS5sb2coXCJCYWxhbmNlXCIsIGJhbGFuY2UpO1xyXG4gICAgcmV0dXJuIGJhbGFuY2U7XHJcbiAgfSBjYXRjaCAoZXJyKSB7XHJcbiAgICBjb25zb2xlLmxvZyhlcnIpO1xyXG4gICAgLy90aHJvdyBlcnI7XHJcbiAgICByZXR1cm4gMDtcclxuICB9XHJcbn1cclxuXHJcbmFzeW5jIGZ1bmN0aW9uIGdldFNvbENvbm5lY3Rpb24oKSB7XHJcbiAgLy8gY29uc3QgY29ubmVjdGlvbiA9IG5ldyBDb25uZWN0aW9uKFNPTEFOQV9SUENfUFJPVklERVIsIFwiY29uZmlybWVkXCIpO1xyXG4gIGNvbnN0IGNvbm5lY3Rpb24gPSBuZXcgQ29ubmVjdGlvbihjbHVzdGVyQXBpVXJsKFwiZGV2bmV0XCIpLFwiY29uZmlybWVkXCIpO1xyXG4gIHJldHVybiBjb25uZWN0aW9uO1xyXG59Il19